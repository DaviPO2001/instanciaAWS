- hosts: terraform-ansible  # Define o grupo de hosts onde as tarefas serão executadas
  become: true              # Usa privilégio de superusuário (sudo) para executar os comandos
  tasks:

    - name: Instalando Python3, pip e virtualenv
      apt:
        pkg:
          - python3         # Instala o interpretador Python 3
          - python3-pip     # Instala o gerenciador de pacotes pip
          - python3-venv    # Instala o módulo para criar ambientes virtuais
        update_cache: yes   # Atualiza o cache de pacotes antes da instalação

    - name: Criando diretório do projeto
      file:
        path: /home/ubuntu/tcc     # Caminho onde o projeto será armazenado
        state: directory           # Garante que o caminho seja um diretório
        owner: ubuntu              # Define o dono do diretório como o usuário ubuntu
        group: ubuntu              # Define o grupo como ubuntu
        mode: '0755'               # Permissões de leitura e execução para todos, escrita apenas para o dono

    - name: criando ambiente virtual
      command: python3 -m venv /home/ubuntu/tcc/virtualenv  # Cria o ambiente virtual com Python
      args:
        creates: /home/ubuntu/tcc/virtualenv/bin/activate   # Só executa se o ambiente ainda não existir

    - name: Instalando dependências com pip (Django e Django REST)
      pip:
        virtualenv: /home/ubuntu/tcc/virtualenv             # Usa o pip do ambiente virtual
        name:
          - Django                                           # Instala o framework Django
          - djangorestframework                              # Instala o Django REST Framework

    - name: Iniciando o projeto Django
      shell: /home/ubuntu/tcc/virtualenv/bin/django-admin startproject setup /home/ubuntu/tcc
      args:
        creates: /home/ubuntu/tcc/manage.py                 # Só executa se o projeto ainda não existir

    - name: Alterando o hosts do settings
      lineinfile:
        path: /home/ubuntu/tcc/setup/settings.py            # Caminho do arquivo settings.py do projeto Django
        regexp: 'ALLOWED_HOSTS'                              # Procura pela linha que contém ALLOWED_HOSTS
        line: 'ALLOWED_HOSTS = ["*"]'                        # Substitui ou insere essa linha permitindo todos os hosts
        backrefs: yes                                        # Garante que a substituição respeite a expressão regular
